name: Playwright Tests

on:
  workflow_dispatch:
    inputs:
      titulo_execucao:
        description: 'TÃ­tulo personalizado para o Webhook'
        required: true
        default: 'ðŸš€ RelatÃ³rio de Testes Automatizados com Playwright'

jobs:
  test:
    name: 'Testes Playwright'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: Instalar dependÃªncias
        run: npm ci
      
      - name: Instalar Playwright Browsers
        run: npx playwright install --with-deps

      - name: Executar testes Playwright
        id: playwright_tests
        run: npx playwright test
        continue-on-error: true
      
      - name: Retry testes com falha
        if: steps.playwright_tests.outcome == 'failure'
        run: npx playwright test --retries=2

      - name: Gerar Dashboard Customizado
        if: always()
        run: |
          node ./libs/Dashboard/main.js ./logs/results/output.xml

      - name: Fazer upload dos logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-logs
          path: ./logs 
          retention-days: 5

      - name: Fazer upload do Dashboard
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-dashboard
          path: ./logs/dashboard_playwright.html
          retention-days: 30

      - name: Enviar relatÃ³rio para Webhook
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          node ./libs/Webhook/report-webhook.js ./logs/results/output.xml --titulo "${{ github.event.inputs.titulo_execucao }}"

      - name: Verificar resultado final dos testes
        if: steps.playwright_tests.outcome == 'failure'
        run: |
          echo "Um ou mais testes falharam apÃ³s todas as retentativas."
          exit 1